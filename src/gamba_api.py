#!/usr/bin/python3

import time
import inspect
import io
import os
import re
import sys
import numpy as np
from flask import Flask
from flask_restful import Resource, Api, reqparse

currentdir = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe())))
sys.path.insert(0, os.path.join(currentdir, "utils"))
from parse import Parser, parse, Node, NodeType, NodeState
from node import mod_red, popcount
from simplify import simplify_linear_mba, check_linear, compute_bitwise_complexity
from simplify_general import simplify_mba

parser = reqparse.RequestParser()

def Step(node : Node, name : str):
    method = getattr(node, "_Node" + name)
    method()
    return
    before = str(node)
    method()
    after = str(node)
    
    if before != after:
        print(name)
        print(f"    Before {name}: {before}")
        print(f"    After {name} : {after}")
    return

def StepWithParent(node : Node, name : str):
    method = getattr(node, "_Node" + name)
    method(None)
    return
    before = str(node)
    method(None)
    after = str(node)
    
    if before != after:
        print(name)
        print(f"    Before {name}: {before}")
        print(f"    After  {name}: {after}")
    return

def Refine(node : Node):
    for c in node.children:
        Refine(c)
    # Refine step 1
    Step(node, "__inspect_constants")
    Step(node, "__flatten")
    Step(node, "__check_duplicate_children")
    Step(node, "__resolve_inverse_nodes")
    Step(node, "__remove_trivial_nodes")

    Step(node, "__eliminate_nested_negations_advanced")
    StepWithParent(node, "__check_bitwise_negations")
    Step(node, "__check_bitwise_powers_of_two")
    Step(node, "__check_beautify_constants_in_products")
    Step(node, "__check_move_in_bitwise_negations")
    Step(node, "__check_bitwise_negations_in_excl_disjunctions")
    StepWithParent(node, "__check_rewrite_powers")
    Step(node, "__check_resolve_product_of_powers")
    Step(node, "__check_resolve_product_of_constant_and_sum")
    Step(node, "__check_factor_out_of_sum")
    Step(node, "__check_resolve_inverse_negations_in_sum")
    Step(node, "__insert_fixed_in_conj")
    Step(node, "__insert_fixed_in_disj")
    Step(node, "__check_trivial_xor")
    Step(node, "__check_xor_same_mult_by_minus_one")
    Step(node, "__check_conj_zero_rule")
    Step(node, "__check_conj_neg_xor_zero_rule")
    Step(node, "__check_conj_neg_xor_minus_one_rule")
    Step(node, "__check_conj_negated_xor_zero_rule")
    Step(node, "__check_conj_xor_identity_rule")
    Step(node, "__check_disj_xor_identity_rule")
    Step(node, "__check_conj_neg_conj_identity_rule")
    Step(node, "__check_disj_disj_identity_rule")
    Step(node, "__check_conj_conj_identity_rule")
    Step(node, "__check_disj_conj_identity_rule")
    Step(node, "__check_disj_conj_identity_rule_2")
    Step(node, "__check_conj_disj_identity_rule")
    Step(node, "__check_disj_neg_disj_identity_rule")
    Step(node, "__check_disj_sub_disj_identity_rule")
    Step(node, "__check_disj_sub_conj_identity_rule")
    Step(node, "__check_conj_add_conj_identity_rule")
    Step(node, "__check_disj_disj_conj_rule")
    Step(node, "__check_conj_conj_disj_rule")
    Step(node, "__check_disj_disj_conj_rule_2")
    




if __name__ == "__main__":
    expression = "((((((((((((a & 255)  | (d ^ -1) )  | ((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) ) )  + 1)  + (((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  ^ -1)  & d)  & (a & 255) ) )  + ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  & ((a & 255)  ^ -1) ) )  + ((a & 255)  & ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  ^ -1) ) )  * 1099511628211)  ^ -1)  & (e ^ -1) )  | ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  & ((((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216)  & ( (((((((((((a & 255)  | (d ^ -1) )  | ((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) ) )  + 1)  + (((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  ^ -1)  & d)  & (a & 255) ) )  + ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  & ((a & 255)  ^ -1) ) )  + ((a & 255)  & ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  ^ -1) ) )  * 1099511628211)  ^ -1)  & (e ^ -1) )  & 4294967295)) ) )  ^ -1) )"

    # expression = "5*(18446744073709551615^x^y)+3*(x&y)+5*(~x&y)+18446744073709551613*x"

    root = None

    for i in range(0, 100):
        root = parse(expression, 64)
    time.sleep(2)

    for i in range(0, 100):
        root = parse(expression, 64)

    start = time.time()
    for i in range(0, 10000):
        root = parse(expression, 64)

    end = time.time()
    print(end - start)
    exit(1)
    print(root)
    print("rooted")
    exit(1)

    for i in range(10):
        for c in root.children:
            Refine(c)
        Refine(root)
    

    root.refine()


    for i in range(2):
        for c in root.children:
            c.expand(True)
            c.mark_linear()
            c.factorize_sums(True)
            c.mark_linear()
            Refine(c)

        root.expand(True)
        root.mark_linear()
        root.factorize_sums(True)
        root.mark_linear()
        root.refine()

    for i in range(15):
        print("processed!")
    root = simplify_mba(root, 64)
    print(f"final: {root}")