#!/usr/bin/python3

import time
import inspect
import io
import os
import re
import sys
import numpy as np
from flask import Flask
from flask_restful import Resource, Api, reqparse


# Reduces the given number modulo given modulus.
def mod_red(n, modulus):
    n = int(n)
    return n % modulus


currentdir = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe())))
sys.path.insert(0, os.path.join(currentdir, "utils"))
from parse import Parser, parse, Node, NodeType, NodeState
from node import mod_red, popcount, Node
from simplify import simplify_linear_mba, check_linear, compute_bitwise_complexity
from simplify_general import simplify_mba

parser = reqparse.RequestParser()

def Step(node : Node, name : str):
    method = getattr(node, "_Node" + name)
    before = str(node)
    method()
    after = str(node)
    
    if before != after:
        print(name)
        print(f"    Before {name}: {before}")
        print(f"    After {name} : {after}")
    return

def StepWithParent(node : Node, parent : Node, name : str):
    method = getattr(node, "_Node" + name)
    before = str(node)
    method(parent)
    after = str(node)
    
    if before != after:
        print(name)
        print(f"    Before {name}: {before}")
        print(f"    After  {name}: {after}")
    return

def RefineStep1(node : Node):
    for c in node.children:
        RefineStep1(c)

        # Refine step 1
    Step(node, "__inspect_constants")
    Step(node, "__flatten")
    Step(node, "__check_duplicate_children")
    Step(node, "__resolve_inverse_nodes")
    Step(node, "__remove_trivial_nodes")

def RefineStep2(node : Node, parent : Node = None):
    for c in node.children:
        RefineStep2(c, node)

    Step(node, "__eliminate_nested_negations_advanced")
    StepWithParent(node, parent, "__check_bitwise_negations")
    Step(node, "__check_bitwise_powers_of_two")
    Step(node, "__check_beautify_constants_in_products")
    Step(node, "__check_move_in_bitwise_negations")
    Step(node, "__check_bitwise_negations_in_excl_disjunctions")
    StepWithParent(node, parent, "__check_rewrite_powers")
    Step(node, "__check_resolve_product_of_powers")
    Step(node, "__check_resolve_product_of_constant_and_sum")
    Step(node, "__check_factor_out_of_sum")
    Step(node, "__check_resolve_inverse_negations_in_sum")
    Step(node, "__insert_fixed_in_conj")
    Step(node, "__insert_fixed_in_disj")
    Step(node, "__check_trivial_xor")
    Step(node, "__check_xor_same_mult_by_minus_one")
    Step(node, "__check_conj_zero_rule")
    Step(node, "__check_conj_neg_xor_zero_rule")
    Step(node, "__check_conj_neg_xor_minus_one_rule")
    Step(node, "__check_conj_negated_xor_zero_rule")
    Step(node, "__check_conj_xor_identity_rule")
    Step(node, "__check_disj_xor_identity_rule")
    Step(node, "__check_conj_neg_conj_identity_rule")
    Step(node, "__check_disj_disj_identity_rule")
    Step(node, "__check_conj_conj_identity_rule")
    Step(node, "__check_disj_conj_identity_rule")
    Step(node, "__check_disj_conj_identity_rule_2")
    Step(node, "__check_conj_disj_identity_rule")
    Step(node, "__check_disj_neg_disj_identity_rule")
    Step(node, "__check_disj_sub_disj_identity_rule")
    Step(node, "__check_disj_sub_conj_identity_rule")
    Step(node, "__check_conj_add_conj_identity_rule")
    Step(node, "__check_disj_disj_conj_rule")
    Step(node, "__check_conj_conj_disj_rule")
    Step(node, "__check_disj_disj_conj_rule_2")


def Refine(node : Node):
    for i in range(10):
        RefineStep1(node)
        RefineStep2(node, None)
    




if __name__ == "__main__":
    expression = "2*(x|~y)-1*(x|y)-2*x+2*(~(x^y))-2*~x-1*(~(x&y))-1*(~(x&~x))-2*y-2*(~(x|y))+6*(~(x|~y))+4*(x&~y)"
    expression = "((((((((((((a & 255)  | (d ^ -1) )  | ((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) ) )  + 1)  + (((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  ^ -1)  & d)  & (a & 255) ) )  + ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  & ((a & 255)  ^ -1) ) )  + ((a & 255)  & ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  ^ -1) ) )  * 1099511628211)  ^ -1)  & (e ^ -1) )  | ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  & ((((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216)  & ( (((((((((((a & 255)  | (d ^ -1) )  | ((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) ) )  + 1)  + (((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  ^ -1)  & d)  & (a & 255) ) )  + ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  & ((a & 255)  ^ -1) ) )  + ((a & 255)  & ((((((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  | c)  * -3298534884633)  + -2199023256422)  + ((((((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) )  + -2199023256422)  ^ (c ^ -1) )  * 2199023256422) )  + ((((2199023256421 - (((((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  * -7696581397477)  + ((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & (b ^ -1) )  * 1099511628211) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  & b)  ^ -1)  * -5497558141055) )  + (((((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  | b)  + (((((2 * (2063597568 & (-16777216 ^ ((-1073741823 + a)  + (4278190080 | (a ^ -1) ) ) ) ) )  - ((((( (a & 4294967295))  & -16777216)  + -1073741824)  ^ -16777216) ) )  * 1099511628211)  + -5808590958014384161)  ^ (b ^ -1) ) )  * 3298534884633) ) )  & c)  - (c ^ -1) )  * 1099511628211) )  | d)  ^ -1) ) )  * 1099511628211)  ^ -1)  & (e ^ -1) )  & 4294967295)) ) )  ^ -1) )"

    
    #constant = -12
    #print(f'trailing zeros: {(constant&-constant).bit_length() - 1}')
    #e = 2
    #mask = (-1 % 32) >> e
    #b = constant & (32 >> (e + 1))

    #constant = -12
    #constant &= mask

    #popcnt = bin(constant).count("1")
    constant = -12
    orig = constant
    e = 1
    modulus = 32

    mask = (-1 % modulus) >> e
    b = constant & (modulus >> (e + 1))

    # Initially unset the irrelevant bits.
    self.constant &= mask

    #print(popcnt)
    print(constant)
   #print(b)
    #exit(1)
    #for i in range(1, 1, -1):
     #   print(i)
    #exit(1)
    exit(1)
    root = parse(expression, 64, False)


    #for i in range(10):
     #   for c in root.children:
      #      Refine(c)
      #  Refine(root)
    
    Refine(root)
    # root.refine()

    print(f"final: {root}")